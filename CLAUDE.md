# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Backend REST API for **Seka Lumbung Mesari**, a cooperative financial management system. Built with NestJS (TypeScript), PostgreSQL, and Knex.js.

## Commands

```bash
# Development
npm run start:dev         # Run with hot-reload
npm run build             # Compile TypeScript to dist/

# Testing
npm run test              # Run unit tests
npm run test:watch        # Run tests in watch mode
npm run test:cov          # Run with coverage report
npm run test:e2e          # Run E2E tests

# Code Quality
npm run lint              # ESLint with auto-fix
npm run format            # Prettier formatting

# Database (Knex.js)
npm run migrate:latest    # Run all pending migrations
npm run migrate:down      # Rollback last migration
npm run migrate:status    # Check migration status
npm run seed:run          # Run all seeders
npm run make:migration    # Create new migration file
```

For local development, start PostgreSQL with:
```bash
docker-compose -f docker-compose-dev.yml up -d
```

## Architecture

**Framework:** NestJS 10 with TypeScript strict mode
**Database:** PostgreSQL via Knex.js (raw SQL query builder, not ORM)
**Auth:** JWT + Passport.js; roles: `SUPERADMIN`, `ADMIN`, `MEMBER`
**API prefix:** `/api`; Swagger docs at `/docs` (requires `MASTER_API_KEY` header)
**Timezone:** Asia/Makassar (WITA, UTC+8) — enforced via `TZ` env var
**Financial math:** Always use `Decimal.js` — never native JS floats

### Module Structure

All feature modules live under `src/` and follow the NestJS pattern: `*.module.ts`, `*.controller.ts`, `*.service.ts`, `*.repository.ts`.

| Module | Responsibility |
|--------|---------------|
| `auth/` | Login, registration, OTP verification, JWT strategy |
| `users/` | User CRUD, approval workflow, role assignment |
| `loans/` | Loan lifecycle: creation → approval → installments → settlement |
| `savings/` | Principal savings and mandatory savings accounts |
| `users-savings/` | Junction linking users to their savings accounts |
| `incomes/` | Income transaction recording and categorization |
| `expenses/` | Expense recording with admin-fee automation |
| `cashbook/` | Transaction history and balance snapshots |
| `reports/` | Monthly financial reports, Excel export via ExcelJS |
| `notifications/` | Email via Nodemailer + Handlebars templates |
| `audit/` | Audit log recording for compliance |
| `common/` | Shared constants, schemas, and utilities |
| `database/` | `DatabaseService` (Knex wrapper), migrations |

### Database Design Notes

- **IDs:** UUID v7 generated by PostgreSQL `uuidv7()` function
- **Balance updates:** Automated via SQL triggers (`cashbook_triggers` migration) — do not duplicate this logic in application code
- **Migrations path:** `src/database/migrations/`; configured in `knexfile.ts`
- **Business constraints:** Enforced at DB level in `create_constraints_business_rules` migration

### Key Configuration (`knexfile.ts`)

- Development: SSL disabled
- Staging: SSL enabled (`rejectUnauthorized: false`)
- Production: SSL disabled by default (can be overridden at runtime)

### Important Environment Variables

```
DB_HOST / DB_PORT / DB_NAME / DB_USER / DB_PASSWORD
JWT_SECRET / JWT_EXPIRES_IN
MASTER_API_KEY               # Protects /docs Swagger UI
ADMIN_FEE_RATE               # e.g. 0.02 (2%)
MANDATORY_SAVINGS_DEFAULT_AMOUNT
MANDATORY_SAVINGS_CRON_SCHEDULE  # Runs automated savings creation
SMTP_HOST / SMTP_PORT / SMTP_USER / SMTP_PASS
TZ=Asia/Makassar
```

### Code Style

- Single quotes, no semicolons, no trailing commas (enforced by Prettier)
- Import order: `@nestjs/*` → third-party → `../` → `./` (enforced by ESLint import plugin)
- Handlebars templates for emails are compiled assets — defined in `src/notifications/templates/`
